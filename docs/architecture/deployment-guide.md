# ELYSIUM Deployment & Infrastructure Guide

**Version:** v1.0  
**Last Updated:** September 9, 2025  
**Generated By:** BMad Architecture Agent  

---

## Deployment Overview

This guide provides comprehensive deployment instructions for the ELYSIUM luxury jewelry e-commerce platform. The platform is optimized for deployment on modern cloud platforms with a focus on performance, security, and scalability.

## Recommended Deployment Stack

### Primary Platform: Vercel (Recommended)
- **Optimized for Next.js:** Native support for Next.js 15 features
- **Global Edge Network:** Low latency for luxury customers worldwide
- **Automatic Scaling:** Handles traffic spikes during promotional events
- **Security:** Built-in SSL, DDoS protection, and security headers

### Alternative Platforms
- **AWS Amplify:** Enterprise features with AWS ecosystem integration
- **Netlify:** Good performance with additional plugin ecosystem
- **Railway:** Simple deployment with database options
- **Self-hosted:** Docker containerization for full control

---

## Pre-Deployment Checklist

### 1. Environment Configuration
```bash
# Required Environment Variables
SANITY_PROJECT_ID=your_sanity_project_id
SANITY_DATASET=production
STRIPE_SECRET_KEY=sk_live_your_stripe_secret_key
STRIPE_PUBLISHABLE_KEY=pk_live_your_stripe_public_key
RESEND_API_KEY=re_your_resend_api_key
NEXT_PUBLIC_SITE_URL=https://your-domain.com

# Optional Environment Variables
SANITY_API_TOKEN=your_sanity_token_with_write_permissions
PLAUSIBLE_DOMAIN=your-domain.com
SENTRY_DSN=your_sentry_dsn_for_error_tracking
```

### 2. Domain & SSL Setup
- Purchase and configure custom domain
- Configure DNS records (A/CNAME)
- SSL certificate (automatic with most platforms)
- Set up subdomain redirects if needed

### 3. Third-party Service Configuration

#### Sanity CMS Setup
```bash
# Install Sanity CLI
npm install -g @sanity/cli

# Login to Sanity
sanity login

# Deploy Sanity Studio (if self-hosting)
sanity deploy
```

#### Stripe Configuration
- Configure webhook endpoints
- Set up payment method types
- Configure tax settings for jurisdiction
- Test payment flows in sandbox

#### Resend Email Configuration
- Verify sending domain
- Configure SPF/DKIM records
- Set up email templates
- Test email delivery

---

## Deployment Methods

### Method 1: Vercel Deployment (Recommended)

#### Automatic Deployment via Git
```bash
# 1. Connect GitHub repository to Vercel
# 2. Configure environment variables in Vercel dashboard
# 3. Deploy automatically on git push

# Vercel CLI deployment (alternative)
npm install -g vercel
vercel login
vercel --prod
```

#### Vercel Configuration
```javascript
// vercel.json
{
  "buildCommand": "npm run build",
  "outputDirectory": ".next",
  "installCommand": "pnpm install",
  "framework": "nextjs",
  "regions": ["lhr1"], // London region for UK customers
  "functions": {
    "app/api/**": {
      "maxDuration": 30
    }
  },
  "headers": [
    {
      "source": "/(.*)",
      "headers": [
        {
          "key": "X-Frame-Options",
          "value": "SAMEORIGIN"
        },
        {
          "key": "X-Content-Type-Options",
          "value": "nosniff"
        },
        {
          "key": "Strict-Transport-Security",
          "value": "max-age=31536000; includeSubDomains"
        }
      ]
    }
  ]
}
```

### Method 2: Docker Deployment

#### Dockerfile
```dockerfile
FROM node:18-alpine AS base

# Install pnpm
RUN corepack enable pnpm

# Install dependencies only when needed
FROM base AS deps
WORKDIR /app

# Install dependencies based on the preferred package manager
COPY package.json pnpm-lock.yaml* ./
RUN pnpm i --frozen-lockfile

# Rebuild the source code only when needed
FROM base AS builder
WORKDIR /app
COPY --from=deps /app/node_modules ./node_modules
COPY . .

# Disable telemetry during build
ENV NEXT_TELEMETRY_DISABLED 1

RUN pnpm build

# Production image, copy all the files and run next
FROM base AS runner
WORKDIR /app

ENV NODE_ENV production
ENV NEXT_TELEMETRY_DISABLED 1

RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs

COPY --from=builder /app/public ./public

# Set correct permissions for pre-rendered cache
RUN mkdir .next
RUN chown nextjs:nodejs .next

# Copy built application
COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static

USER nextjs

EXPOSE 3000

ENV PORT 3000
ENV HOSTNAME "0.0.0.0"

CMD ["node", "server.js"]
```

#### Docker Compose for Development
```yaml
# docker-compose.yml
version: '3.8'

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - SANITY_PROJECT_ID=${SANITY_PROJECT_ID}
      - SANITY_DATASET=${SANITY_DATASET}
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}
      - STRIPE_PUBLISHABLE_KEY=${STRIPE_PUBLISHABLE_KEY}
      - RESEND_API_KEY=${RESEND_API_KEY}
      - NEXT_PUBLIC_SITE_URL=${NEXT_PUBLIC_SITE_URL}
    volumes:
      - ./.env.local:/app/.env.local:ro
    restart: unless-stopped

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/nginx/ssl:ro
    depends_on:
      - app
    restart: unless-stopped
```

### Method 3: AWS Amplify Deployment

#### amplify.yml Configuration
```yaml
version: 1
applications:
  - frontend:
      phases:
        preBuild:
          commands:
            - corepack enable pnpm
            - pnpm install
        build:
          commands:
            - pnpm run build
      artifacts:
        baseDirectory: .next
        files:
          - '**/*'
      cache:
        paths:
          - node_modules/**/*
          - .next/cache/**/*
    appRoot: /
```

---

## Infrastructure Requirements

### Compute Resources

#### Minimum Requirements (Development/Testing)
- **CPU:** 1 vCPU
- **Memory:** 1GB RAM
- **Storage:** 10GB SSD
- **Bandwidth:** 100Mbps

#### Recommended Requirements (Production)
- **CPU:** 2-4 vCPUs
- **Memory:** 4-8GB RAM
- **Storage:** 50GB SSD
- **Bandwidth:** 1Gbps
- **Regions:** Multi-region for global customers

#### Scaling Requirements (High Traffic)
- **CPU:** 8+ vCPUs (auto-scaling)
- **Memory:** 16+ GB RAM
- **CDN:** Global edge caching
- **Database:** Read replicas for Sanity CMS
- **Load Balancer:** Health checks and failover

### Storage Requirements
- **Static Assets:** 5-10GB for product images
- **CDN Cache:** Unlimited (managed by platform)
- **Logs:** 1-5GB per month
- **Backups:** 3x data volume for redundancy

---

## Security Configuration

### SSL/TLS Setup
```nginx
# nginx.conf example for custom deployment
server {
    listen 443 ssl http2;
    server_name your-domain.com;
    
    ssl_certificate /etc/nginx/ssl/fullchain.pem;
    ssl_certificate_key /etc/nginx/ssl/privkey.pem;
    
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options SAMEORIGIN always;
    add_header X-Content-Type-Options nosniff always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

### Security Headers (Already configured in Next.js)
```javascript
// next.config.mjs
const securityHeaders = [
  {
    key: 'X-DNS-Prefetch-Control',
    value: 'on'
  },
  {
    key: 'Strict-Transport-Security',
    value: 'max-age=63072000; includeSubDomains; preload'
  },
  {
    key: 'X-XSS-Protection',
    value: '1; mode=block'
  },
  {
    key: 'X-Frame-Options',
    value: 'SAMEORIGIN'
  },
  {
    key: 'Permissions-Policy',
    value: 'camera=(), microphone=(), geolocation=()'
  },
  {
    key: 'X-Content-Type-Options',
    value: 'nosniff'
  },
  {
    key: 'Referrer-Policy',
    value: 'origin-when-cross-origin'
  }
];
```

---

## Monitoring & Observability

### Essential Monitoring Setup

#### Application Performance Monitoring
```javascript
// Recommended Sentry integration
import * as Sentry from "@sentry/nextjs";

Sentry.init({
  dsn: process.env.SENTRY_DSN,
  tracesSampleRate: 1.0,
  environment: process.env.NODE_ENV,
});
```

#### Health Check Endpoints
```typescript
// app/api/health/route.ts
export async function GET() {
  const health = {
    status: 'ok',
    timestamp: new Date().toISOString(),
    services: {
      sanity: await checkSanityConnection(),
      stripe: await checkStripeConnection(),
      resend: await checkResendConnection()
    }
  };
  
  return Response.json(health);
}
```

#### Logging Configuration
```javascript
// Structured logging setup
const winston = require('winston');

const logger = winston.createLogger({
  level: 'info',
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.errors({ stack: true }),
    winston.format.json()
  ),
  defaultMeta: { service: 'elysium-storefront' },
  transports: [
    new winston.transports.File({ filename: 'error.log', level: 'error' }),
    new winston.transports.File({ filename: 'combined.log' })
  ]
});
```

### Analytics Setup
```javascript
// Plausible Analytics (privacy-focused)
// Add to app/layout.tsx
<Script
  defer
  data-domain="your-domain.com"
  src="https://plausible.io/js/script.js"
/>
```

---

## Performance Optimization

### Build Optimization
```javascript
// next.config.mjs performance settings
const nextConfig = {
  experimental: {
    optimizePackageImports: ['swr', 'zustand', 'gsap'],
  },
  images: {
    formats: ['image/webp', 'image/avif'],
    deviceSizes: [640, 750, 828, 1080, 1200, 1920, 2048, 3840],
  },
  compress: true,
  poweredByHeader: false,
};
```

### CDN Configuration
```javascript
// Vercel Edge Config for caching
const cacheConfig = {
  static: '31536000', // 1 year for static assets
  api: '300',         // 5 minutes for API responses
  pages: '3600'       // 1 hour for pages
};
```

### Image Optimization Strategy
- **Format:** WebP with AVIF fallback
- **Sizing:** Responsive breakpoints for all devices
- **Lazy Loading:** Implemented via Next.js Image component
- **CDN:** Sanity CDN for product images

---

## Database & CMS Deployment

### Sanity CMS Production Setup
```bash
# Production dataset configuration
sanity dataset create production

# Deploy Sanity Studio to subdomain
sanity deploy studio --source-maps

# Configure CORS for production domain
sanity cors add https://your-domain.com --credentials
```

### Content Migration Strategy
```typescript
// Migration script for content updates
interface MigrationPlan {
  backup: 'Export current dataset before changes';
  validate: 'Test migration on staging dataset';
  migrate: 'Run migration with rollback capability';
  verify: 'Validate data integrity post-migration';
}
```

---

## CI/CD Pipeline

### GitHub Actions Workflow
```yaml
# .github/workflows/deploy.yml
name: Deploy to Production

on:
  push:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: pnpm/action-setup@v2
        with:
          version: 8
          
      - uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'pnpm'
          
      - run: pnpm install --frozen-lockfile
      
      - run: pnpm run typecheck
      
      - run: pnpm run lint
      
      - run: pnpm run build
      
      - name: Run E2E Tests
        run: pnpm playwright test
        
      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.ORG_ID }}
          vercel-project-id: ${{ secrets.PROJECT_ID }}
          vercel-args: '--prod'
```

### Quality Gates
1. **TypeScript Check:** Zero type errors
2. **Linting:** ESLint passes
3. **Build Success:** Next.js builds without errors
4. **E2E Tests:** Critical user journeys pass
5. **Performance:** Lighthouse scores meet thresholds

---

## Backup & Disaster Recovery

### Data Backup Strategy
```typescript
interface BackupStrategy {
  sanity: {
    frequency: 'Daily automated exports';
    retention: '30 days rolling backup';
    storage: 'Multiple geographic locations';
  };
  media: {
    source: 'Sanity CDN with built-in redundancy';
    backup: 'Additional S3 backup for critical assets';
  };
  configuration: {
    envVars: 'Secure vault with access controls';
    secrets: 'Encrypted storage with rotation';
  };
}
```

### Recovery Procedures
1. **Database Recovery:** Restore from Sanity export
2. **Application Recovery:** Redeploy from Git repository
3. **DNS Recovery:** Backup DNS configuration
4. **SSL Recovery:** Certificate renewal automation

---

## Scaling Considerations

### Horizontal Scaling
- **Load Balancing:** Geographic distribution
- **CDN Scaling:** Edge cache optimization
- **API Scaling:** Serverless function scaling
- **Database Scaling:** Read replicas for Sanity

### Vertical Scaling
- **Memory Optimization:** Monitor Node.js heap usage
- **CPU Optimization:** Optimize expensive operations
- **Network Optimization:** Bundle size reduction

### Cost Optimization
```typescript
interface CostOptimization {
  compute: 'Auto-scaling based on demand';
  storage: 'Lifecycle policies for old data';
  bandwidth: 'CDN caching to reduce origin requests';
  services: 'Reserved instances for predictable workloads';
}
```

---

## Troubleshooting Guide

### Common Deployment Issues

#### Build Failures
```bash
# Check Node.js version compatibility
node --version # Should be 18+

# Clear package cache
pnpm store prune

# Rebuild with fresh dependencies
rm -rf node_modules .next
pnpm install
pnpm run build
```

#### Environment Variable Issues
```bash
# Verify all required variables are set
echo $SANITY_PROJECT_ID
echo $STRIPE_SECRET_KEY
echo $RESEND_API_KEY

# Check for typos in variable names
cat .env.local | grep -E "^[A-Z_]+="
```

#### Performance Issues
```bash
# Bundle analysis
pnpm run build -- --analyze

# Memory profiling
NODE_OPTIONS="--max-old-space-size=4096" pnpm run build

# Network debugging
curl -I https://your-domain.com
```

### Emergency Procedures
1. **Immediate Rollback:** Revert to last known good deployment
2. **Traffic Diversion:** Maintenance page activation
3. **Service Status:** Update status page and notifications
4. **Incident Response:** Follow established escalation procedures

---

## Post-Deployment Checklist

### Functional Verification
- [ ] Home page loads correctly
- [ ] Product pages display properly
- [ ] Search and filtering work
- [ ] Cart and checkout flow complete
- [ ] Email notifications send
- [ ] Payment processing works
- [ ] Mobile responsive design

### Performance Verification
- [ ] Lighthouse scores > 90
- [ ] Core Web Vitals pass
- [ ] Image optimization working
- [ ] CDN cache hit rates > 90%
- [ ] API response times < 200ms

### Security Verification
- [ ] SSL certificate valid
- [ ] Security headers present
- [ ] No sensitive data exposed
- [ ] CORS properly configured
- [ ] Rate limiting active (future)

### Monitoring Setup
- [ ] Error tracking configured
- [ ] Performance monitoring active
- [ ] Log aggregation working
- [ ] Health checks passing
- [ ] Alerts configured

---

*This deployment guide should be updated as the infrastructure evolves and new requirements emerge.*